<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R7 Assessment System v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        .grade-a { background: #22c55e; color: white; }
        .grade-b { background: #3b82f6; color: white; }
        .grade-c { background: #eab308; color: white; }
        .grade-d { background: #ef4444; color: white; }
        .dim-card { transition: transform 0.2s; }
        .dim-card:hover { transform: translateY(-2px); }
        .criteria-box { background: #f0f9ff; border-left: 4px solid #3b82f6; }
        .loading { opacity: 0.6; pointer-events: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- API URL -->
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzYRBtTbeZZ_w4yM15PlqNgvAFNU1lj98mZwgpaXqTVPQxkS7SgvyQPVJHNvkUkzT4hNA/exec';
    </script>

    <!-- Header -->
    <header class="bg-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold">üìä R7 Assessment System</h1>
            <div id="userInfo" class="hidden flex items-center gap-4">
                <span id="userName" class="text-sm"></span>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </header>

    <!-- Login Page -->
    <div id="loginPage" class="flex items-center justify-center min-h-[80vh]">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <div id="loginError" class="hidden bg-red-100 text-red-700 p-3 rounded mb-4"></div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Username</label>
                <input type="text" id="username" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="admin ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™ ‡∏£‡∏û.">
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 mb-2">Password</label>
                <input type="password" id="password" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            </div>
            <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <p class="text-center text-gray-500 mt-4 text-sm">‡πÄ‡∏Ç‡∏ï‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 7</p>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden container mx-auto px-4 py-6">
        <h2 class="text-2xl font-bold mb-6">üìä Admin Dashboard</h2>
        
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-gray-500 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏£‡∏û. ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div id="totalHospitals" class="text-3xl font-bold text-blue-600">-</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-gray-500 text-sm">Grade A-B</div>
                <div id="gradeAB" class="text-3xl font-bold text-green-600">-</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-gray-500 text-sm">Grade C</div>
                <div id="gradeC" class="text-3xl font-bold text-yellow-600">-</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="text-gray-500 text-sm">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                <div id="avgScore" class="text-3xl font-bold text-purple-600">-</div>
            </div>
        </div>

        <!-- Filter & Export -->
        <div class="bg-white p-4 rounded-lg shadow mb-6 flex flex-wrap gap-4 items-center">
            <div>
                <label class="text-gray-600 mr-2">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</label>
                <select id="filterProvince" onchange="filterTable()" class="border p-2 rounded">
                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô">‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô</option>
                    <option value="‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå">‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå</option>
                    <option value="‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°">‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°</option>
                    <option value="‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î">‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î</option>
                </select>
            </div>
            <div>
                <label class="text-gray-600 mr-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö:</label>
                <select id="filterLevel" onchange="filterTable()" class="border p-2 rounded">
                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="A">A (‡∏£‡∏û‡∏®.)</option>
                    <option value="M1">M1</option>
                    <option value="F2">F2 (‡∏£‡∏û‡∏ä.)</option>
                </select>
            </div>
            <button onclick="exportAdminExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded ml-auto">
                üì• Export Excel
            </button>
        </div>

        <!-- Hospital Table -->
        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-3 text-left">‡∏£‡∏´‡∏±‡∏™</th>
                        <th class="p-3 text-left">‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏û.</th>
                        <th class="p-3 text-left">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                        <th class="p-3 text-center">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                        <th class="p-3 text-center">Composite</th>
                        <th class="p-3 text-center">Grade</th>
                        <th class="p-3 text-center">‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                    </tr>
                </thead>
                <tbody id="hospitalTableBody">
                    <tr><td colspan="7" class="p-4 text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Hospital Dashboard -->
    <div id="hospitalDashboard" class="hidden container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Hospital Info -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 id="hospitalName" class="text-2xl font-bold text-gray-800 mb-2">-</h3>
                    <p id="hospitalProvince" class="text-gray-600 mb-1">-</p>
                    <span id="hospitalLevel" class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">-</span>
                </div>

                <!-- Score Card -->
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <div class="text-center">
                        <div class="text-gray-500 mb-2">Composite Score</div>
                        <div id="hospitalComposite" class="text-5xl font-bold text-blue-600 mb-2">-</div>
                        <div id="hospitalGrade" class="inline-block px-4 py-2 rounded-full text-lg font-bold">-</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-3">
                    <button onclick="showAssessmentForm()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold">
                        üìù ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà
                    </button>
                    <button onclick="exportHospitalExcel()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold">
                        üì• Export Excel
                    </button>
                </div>
            </div>

            <!-- Dimension Scores -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h4 class="text-lg font-bold mb-4">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏°‡∏¥‡∏ï‡∏¥</h4>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="dim-card bg-red-50 p-4 rounded-lg text-center">
                            <div class="text-red-600 font-bold text-2xl" id="dimRevenue">-</div>
                            <div class="text-gray-600 text-sm">Revenue (35%)</div>
                        </div>
                        <div class="dim-card bg-yellow-50 p-4 rounded-lg text-center">
                            <div class="text-yellow-600 font-bold text-2xl" id="dimCost">-</div>
                            <div class="text-gray-600 text-sm">Cost (15%)</div>
                        </div>
                        <div class="dim-card bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-blue-600 font-bold text-2xl" id="dimDiscipline">-</div>
                            <div class="text-gray-600 text-sm">Discipline (30%)</div>
                        </div>
                        <div class="dim-card bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-green-600 font-bold text-2xl" id="dimCollection">-</div>
                            <div class="text-gray-600 text-sm">Collection (15%)</div>
                        </div>
                        <div class="dim-card bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-purple-600 font-bold text-2xl" id="dimProcess">-</div>
                            <div class="text-gray-600 text-sm">Process (5%)</div>
                        </div>
                    </div>
                </div>

                <!-- Best Practice -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h4 class="text-lg font-bold mb-4">üèÜ ‡∏£‡∏û.‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)</h4>
                    <div id="bestPracticeInfo" class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
            </div>
        </div>

        <!-- Assessment History -->
        <div class="bg-white p-6 rounded-lg shadow mt-6">
            <h4 class="text-lg font-bold mb-4">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h4>
            <div id="assessmentHistory" class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
    </div>

    <!-- Assessment Form -->
    <div id="assessmentForm" class="hidden container mx-auto px-4 py-6">
        <div class="bg-white p-6 rounded-lg shadow">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">üìù ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á</h3>
                <button onclick="hideAssessmentForm()" class="text-gray-500 hover:text-gray-700">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div>

            <!-- Form Header -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                <div>
                    <label class="block text-gray-600 mb-1">‡∏£‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</label>
                    <select id="assessRound" class="w-full p-2 border rounded">
                        <option value="1/2568">1/2568 (‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏õ‡∏µ‡πÅ‡∏£‡∏Å)</option>
                        <option value="2/2568">2/2568 (‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏õ‡∏µ‡∏´‡∏•‡∏±‡∏á)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-600 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</label>
                    <input type="date" id="assessDate" class="w-full p-2 border rounded">
                </div>
                <div class="text-center">
                    <div class="text-gray-600 mb-1">Live Score</div>
                    <div class="text-3xl font-bold">
                        <span id="liveComposite" class="text-blue-600">0</span>
                        <span id="liveGrade" class="ml-2 px-2 py-1 rounded text-sm">-</span>
                    </div>
                </div>
            </div>

            <!-- Assessment Items -->
            <div id="assessmentItems">
                <!-- Will be populated by JavaScript -->
            </div>

            <!-- Save Button -->
            <div class="mt-6 text-center">
                <button onclick="saveAssessment()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold text-lg">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL VARIABLES ====================
        let currentUser = null;
        let currentHospital = null;
        let allHospitals = [];
        let allScores = [];
        let allCriteria = [];

        // ==================== API FUNCTIONS ====================
        async function callAPI(action, params = {}) {
            const url = new URL(API_URL);
            url.searchParams.append('action', action);
            for (let key in params) {
                url.searchParams.append(key, params[key]);
            }
            
            try {
                const response = await fetch(url);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, error: error.message };
            }
        }

        async function postAPI(data) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, error: error.message };
            }
        }

        // ==================== AUTH ====================
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showLoginError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username ‡πÅ‡∏•‡∏∞ Password');
                return;
            }

            const result = await callAPI('login', { username, password });
            
            if (result.success) {
                currentUser = result.user;
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userName').textContent = `üë§ ${currentUser.username} (${currentUser.role})`;
                
                if (currentUser.role === 'admin') {
                    loadAdminDashboard();
                } else {
                    loadHospitalDashboard(currentUser.hospital_code);
                }
            } else {
                showLoginError(result.error || '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        function showLoginError(msg) {
            const el = document.getElementById('loginError');
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function logout() {
            currentUser = null;
            currentHospital = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('hospitalDashboard').classList.add('hidden');
            document.getElementById('assessmentForm').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }

        // ==================== ADMIN DASHBOARD ====================
        async function loadAdminDashboard() {
            document.getElementById('adminDashboard').classList.remove('hidden');
            
            // Load hospitals
            const hospResult = await callAPI('getHospitals');
            if (hospResult.success) {
                allHospitals = hospResult.hospitals;
                document.getElementById('totalHospitals').textContent = allHospitals.length;
            }

            // Load all scores
            const scoreResult = await callAPI('getAllScores');
            if (scoreResult.success) {
                allScores = scoreResult.scores;
            }

            // Load criteria
            const critResult = await callAPI('getCriteria');
            if (critResult.success) {
                allCriteria = critResult.criteria;
            }

            updateAdminStats();
            renderHospitalTable();
        }

        function updateAdminStats() {
            // Get latest score for each hospital
            const latestScores = {};
            allScores.forEach(s => {
                const code = s.hospital_code;
                if (!latestScores[code] || s.updated_at > latestScores[code].updated_at) {
                    latestScores[code] = s;
                }
            });

            let gradeAB = 0, gradeC = 0, totalScore = 0, count = 0;
            Object.values(latestScores).forEach(s => {
                const comp = Number(s.composite) || 0;
                if (comp >= 75) gradeAB++;
                else if (comp >= 65) gradeC++;
                totalScore += comp;
                count++;
            });

            document.getElementById('gradeAB').textContent = gradeAB;
            document.getElementById('gradeC').textContent = gradeC;
            document.getElementById('avgScore').textContent = count > 0 ? Math.round(totalScore / count) : '-';
        }

        function renderHospitalTable() {
            const tbody = document.getElementById('hospitalTableBody');
            const filterProv = document.getElementById('filterProvince').value;
            const filterLevel = document.getElementById('filterLevel').value;

            // Get latest scores map
            const latestScores = {};
            allScores.forEach(s => {
                const code = s.hospital_code;
                if (!latestScores[code] || s.updated_at > latestScores[code].updated_at) {
                    latestScores[code] = s;
                }
            });

            let filtered = allHospitals;
            if (filterProv) filtered = filtered.filter(h => h.province === filterProv);
            if (filterLevel) filtered = filtered.filter(h => h.level === filterLevel);

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(h => {
                const score = latestScores[h.code];
                const comp = score ? score.composite : '-';
                const grade = score ? score.grade : '-';
                const round = score ? score.round : '-';
                const gradeClass = grade === 'A' ? 'grade-a' : grade === 'B' ? 'grade-b' : grade === 'C' ? 'grade-c' : grade === 'D' ? 'grade-d' : 'bg-gray-200';
                
                return `<tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${h.code}</td>
                    <td class="p-3 font-medium">${h.name}</td>
                    <td class="p-3">${h.province}</td>
                    <td class="p-3 text-center"><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">${h.level}</span></td>
                    <td class="p-3 text-center font-bold">${comp}</td>
                    <td class="p-3 text-center"><span class="px-2 py-1 rounded ${gradeClass}">${grade}</span></td>
                    <td class="p-3 text-center text-sm">${round}</td>
                </tr>`;
            }).join('');
        }

        function filterTable() {
            renderHospitalTable();
        }

        // ==================== HOSPITAL DASHBOARD ====================
        async function loadHospitalDashboard(code) {
            document.getElementById('hospitalDashboard').classList.remove('hidden');

            // Load hospital info
            const hospResult = await callAPI('getHospital', { code });
            if (hospResult.success) {
                currentHospital = hospResult.hospital;
                document.getElementById('hospitalName').textContent = currentHospital.name;
                document.getElementById('hospitalProvince').textContent = `üìç ${currentHospital.province}`;
                document.getElementById('hospitalLevel').textContent = `‡∏£‡∏∞‡∏î‡∏±‡∏ö ${currentHospital.level}`;
            }

            // Load scores
            const scoreResult = await callAPI('getScores', { hospital_code: code });
            if (scoreResult.success && scoreResult.scores.length > 0) {
                // Get latest score
                const latest = scoreResult.scores.sort((a, b) => b.updated_at > a.updated_at ? 1 : -1)[0];
                displayHospitalScore(latest);
                displayAssessmentHistory(scoreResult.scores);
            } else {
                document.getElementById('hospitalComposite').textContent = '-';
                document.getElementById('hospitalGrade').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                document.getElementById('hospitalGrade').className = 'inline-block px-4 py-2 rounded-full text-lg bg-gray-200';
                document.getElementById('assessmentHistory').innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</p>';
            }

            // Load criteria
            const critResult = await callAPI('getCriteria');
            if (critResult.success) {
                allCriteria = critResult.criteria;
            }

            // Load best practice
            loadBestPractice(currentHospital.level);
        }

        function displayHospitalScore(score) {
            document.getElementById('hospitalComposite').textContent = score.composite || '-';
            
            const grade = score.grade || '-';
            const gradeEl = document.getElementById('hospitalGrade');
            gradeEl.textContent = `Grade ${grade}`;
            gradeEl.className = 'inline-block px-4 py-2 rounded-full text-lg font-bold ' + 
                (grade === 'A' ? 'grade-a' : grade === 'B' ? 'grade-b' : grade === 'C' ? 'grade-c' : 'grade-d');

            document.getElementById('dimRevenue').textContent = score.dim_revenue || '-';
            document.getElementById('dimCost').textContent = score.dim_cost || '-';
            document.getElementById('dimDiscipline').textContent = score.dim_discipline || '-';
            document.getElementById('dimCollection').textContent = score.dim_collection || '-';
            document.getElementById('dimProcess').textContent = score.dim_process || '-';
        }

        function displayAssessmentHistory(scores) {
            const container = document.getElementById('assessmentHistory');
            if (scores.length === 0) {
                container.innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</p>';
                return;
            }

            container.innerHTML = `
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 text-left">‡∏£‡∏≠‡∏ö</th>
                            <th class="p-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th class="p-2 text-center">Raw Score</th>
                            <th class="p-2 text-center">Composite</th>
                            <th class="p-2 text-center">Grade</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scores.map(s => `
                            <tr class="border-b">
                                <td class="p-2">${s.round || '-'}</td>
                                <td class="p-2">${s.date || '-'}</td>
                                <td class="p-2 text-center">${s.total_raw || '-'}/150</td>
                                <td class="p-2 text-center font-bold">${s.composite || '-'}</td>
                                <td class="p-2 text-center"><span class="px-2 py-1 rounded ${s.grade === 'A' ? 'grade-a' : s.grade === 'B' ? 'grade-b' : s.grade === 'C' ? 'grade-c' : 'grade-d'}">${s.grade || '-'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function loadBestPractice(level) {
            const result = await callAPI('getBestPractice', { level });
            const container = document.getElementById('bestPracticeInfo');
            
            if (result.success && result.bestPractice) {
                const bp = result.bestPractice;
                // Get hospital name
                const hospResult = await callAPI('getHospital', { code: bp.hospital_code });
                const hospName = hospResult.success ? hospResult.hospital.name : bp.hospital_code;
                
                container.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="text-4xl">üèÜ</div>
                        <div>
                            <div class="font-bold text-lg">${hospName}</div>
                            <div class="text-gray-600">Composite: <span class="font-bold text-blue-600">${bp.composite}</span> | Grade: <span class="font-bold">${bp.grade}</span></div>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏£‡∏û.‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏µ‡πâ</p>';
            }
        }

        // ==================== ASSESSMENT FORM ====================
        function showAssessmentForm() {
            document.getElementById('hospitalDashboard').classList.add('hidden');
            document.getElementById('assessmentForm').classList.remove('hidden');
            document.getElementById('assessDate').value = new Date().toISOString().split('T')[0];
            renderAssessmentItems();
        }

        function hideAssessmentForm() {
            document.getElementById('assessmentForm').classList.add('hidden');
            document.getElementById('hospitalDashboard').classList.remove('hidden');
        }

        function renderAssessmentItems() {
            const container = document.getElementById('assessmentItems');
            
            const categories = [
                { id: 1, name: '‡∏´‡∏°‡∏ß‡∏î 1: ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô', color: 'blue' },
                { id: 2, name: '‡∏´‡∏°‡∏ß‡∏î 2: ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', color: 'green' },
                { id: 3, name: '‡∏´‡∏°‡∏ß‡∏î 3: ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û', color: 'purple' },
                { id: 4, name: '‡∏´‡∏°‡∏ß‡∏î 4: ‡πÅ‡∏ú‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2 ‡∏à‡∏≤‡∏Å 5 ‡∏Ç‡πâ‡∏≠)', color: 'orange' },
                { id: 5, name: '‡∏´‡∏°‡∏ß‡∏î 5: PP Fee Schedule', color: 'pink' },
                { id: 6, name: '‡∏´‡∏°‡∏ß‡∏î 6: ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', color: 'red' }
            ];

            let html = '';
            categories.forEach(cat => {
                const items = allCriteria.filter(c => c.category === cat.id);
                
                html += `
                    <div class="mb-6 border rounded-lg overflow-hidden">
                        <div class="bg-${cat.color}-100 p-4 font-bold text-${cat.color}-800">${cat.name}</div>
                        <div class="p-4 space-y-4">
                `;

                items.forEach(item => {
                    const itemKey = item.item_code.replace('.', '_');
                    const isCat4 = cat.id === 4;
                    const isLevel64 = item.item_code === '6.4';
                    const showItem = !isLevel64 || (currentHospital && ['M1', 'M2', 'A'].includes(currentHospital.level));

                    if (!showItem) return;

                    html += `
                        <div class="border-b pb-4" id="item_wrapper_${itemKey}">
                            <div class="flex items-start gap-4">
                                ${isCat4 ? `<input type="checkbox" id="cat4_check_${itemKey}" class="mt-1 w-5 h-5" onchange="toggleCat4Item('${itemKey}')">` : ''}
                                <div class="flex-1">
                                    <label class="font-medium text-gray-700">${item.item_code} ${item.item_name}</label>
                                    <div class="mt-2 flex items-center gap-4">
                                        <select id="score_${itemKey}" class="border p-2 rounded w-32 ${isCat4 ? 'opacity-50' : ''}" 
                                            onchange="onScoreChange('${itemKey}')" ${isCat4 ? 'disabled' : ''}>
                                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <span class="text-gray-400 text-sm">/ 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                                    </div>
                                    <div id="criteria_${itemKey}" class="criteria-box mt-2 p-3 hidden rounded">
                                        <span class="text-sm text-gray-600"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
            });

            container.innerHTML = html;
        }

        function toggleCat4Item(itemKey) {
            const checkbox = document.getElementById(`cat4_check_${itemKey}`);
            const select = document.getElementById(`score_${itemKey}`);
            
            // Count checked items in cat4
            const cat4Checks = document.querySelectorAll('[id^="cat4_check_4_"]');
            const checkedCount = Array.from(cat4Checks).filter(c => c.checked).length;

            if (checkbox.checked && checkedCount > 2) {
                checkbox.checked = false;
                alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 2 ‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                return;
            }

            select.disabled = !checkbox.checked;
            select.classList.toggle('opacity-50', !checkbox.checked);
            if (!checkbox.checked) {
                select.value = '';
                document.getElementById(`criteria_${itemKey}`).classList.add('hidden');
            }
            
            updateLiveScore();
        }

        function onScoreChange(itemKey) {
            const select = document.getElementById(`score_${itemKey}`);
            const criteriaBox = document.getElementById(`criteria_${itemKey}`);
            const score = select.value;

            if (score !== '') {
                const itemCode = itemKey.replace('_', '.');
                const item = allCriteria.find(c => c.item_code === itemCode);
                if (item) {
                    const criteriaText = item[`score_${score}`] || '';
                    criteriaBox.innerHTML = `<span class="font-medium text-blue-700">${score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</span> <span class="text-gray-700">${criteriaText}</span>`;
                    criteriaBox.classList.remove('hidden');
                }
            } else {
                criteriaBox.classList.add('hidden');
            }

            updateLiveScore();
        }

        function updateLiveScore() {
            const data = collectFormData();
            const dims = calculateDimensions(data);
            
            document.getElementById('liveComposite').textContent = dims.composite;
            
            const gradeEl = document.getElementById('liveGrade');
            gradeEl.textContent = dims.grade;
            gradeEl.className = 'ml-2 px-2 py-1 rounded text-sm font-bold ' +
                (dims.grade === 'A' ? 'grade-a' : dims.grade === 'B' ? 'grade-b' : dims.grade === 'C' ? 'grade-c' : 'grade-d');
        }

        function collectFormData() {
            const data = {
                hospital_code: currentHospital.code,
                round: document.getElementById('assessRound').value,
                date: document.getElementById('assessDate').value,
                cat4_selected: []
            };

            // Collect all scores
            allCriteria.forEach(item => {
                const itemKey = item.item_code.replace('.', '_');
                const select = document.getElementById(`score_${itemKey}`);
                if (select && !select.disabled) {
                    data[`item_${itemKey}`] = select.value || '';
                }

                // Check cat4 selections
                if (item.category === 4) {
                    const checkbox = document.getElementById(`cat4_check_${itemKey}`);
                    if (checkbox && checkbox.checked) {
                        data.cat4_selected.push(item.item_code);
                    }
                }
            });

            data.cat4_selected = data.cat4_selected.join(',');
            return data;
        }

        function calculateDimensions(data) {
            // Revenue: selected cat4 items + 5.1
            let revenueSum = 0, revenueMax = 15;
            ['4_1','4_2','4_3','4_4','4_5'].forEach(item => {
                if (data.cat4_selected.includes(item.replace('_','.'))) {
                    revenueSum += Number(data['item_' + item] || 0);
                }
            });
            revenueSum += Number(data.item_5_1 || 0);

            // Cost: 6.1-6.5
            let costSum = 0, costMax = 25;
            ['6_1','6_2','6_3','6_4','6_5'].forEach(item => {
                costSum += Number(data['item_' + item] || 0);
            });

            // Discipline: 1.3-1.6, 3.12, 3.13
            let discSum = 0, discMax = 30;
            ['1_3','1_4','1_5','1_6','3_12','3_13'].forEach(item => {
                discSum += Number(data['item_' + item] || 0);
            });

            // Collection: 3.7-3.11
            let collSum = 0, collMax = 25;
            ['3_7','3_8','3_9','3_10','3_11'].forEach(item => {
                collSum += Number(data['item_' + item] || 0);
            });

            // Process
            let procSum = 0, procMax = 55;
            ['1_1','1_2','2_1','2_2','3_1','3_2','3_3','3_4','3_5','3_6','3_14'].forEach(item => {
                procSum += Number(data['item_' + item] || 0);
            });

            const revenue = Math.round((revenueSum / revenueMax) * 100);
            const cost = Math.round((costSum / costMax) * 100);
            const discipline = Math.round((discSum / discMax) * 100);
            const collection = Math.round((collSum / collMax) * 100);
            const process = Math.round((procSum / procMax) * 100);

            const composite = Math.round(revenue * 0.35 + cost * 0.15 + discipline * 0.30 + collection * 0.15 + process * 0.05);

            let grade = 'D';
            if (composite >= 85) grade = 'A';
            else if (composite >= 75) grade = 'B';
            else if (composite >= 65) grade = 'C';

            return { revenue, cost, discipline, collection, process, composite, grade };
        }

        async function saveAssessment() {
            const data = collectFormData();
            data.action = 'saveScore';

            // Validate
            if (!data.date) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô');
                return;
            }

            // Check cat4 selection
            if (data.cat4_selected.split(',').filter(x => x).length !== 2) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏´‡∏°‡∏ß‡∏î 4 ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 2 ‡∏Ç‡πâ‡∏≠');
                return;
            }

            const result = await postAPI(data);
            
            if (result.success) {
                alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\nComposite Score: ${result.composite}\nGrade: ${result.grade}`);
                hideAssessmentForm();
                loadHospitalDashboard(currentHospital.code);
            } else {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ'));
            }
        }

        // ==================== EXPORT ====================
        function exportAdminExcel() {
            const latestScores = {};
            allScores.forEach(s => {
                const code = s.hospital_code;
                if (!latestScores[code] || s.updated_at > latestScores[code].updated_at) {
                    latestScores[code] = s;
                }
            });

            const data = allHospitals.map(h => {
                const score = latestScores[h.code] || {};
                return {
                    '‡∏£‡∏´‡∏±‡∏™': h.code,
                    '‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏û.': h.name,
                    '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î': h.province,
                    '‡∏£‡∏∞‡∏î‡∏±‡∏ö': h.level,
                    '‡∏£‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô': score.round || '-',
                    'Raw Score': score.total_raw || '-',
                    'Revenue': score.dim_revenue || '-',
                    'Cost': score.dim_cost || '-',
                    'Discipline': score.dim_discipline || '-',
                    'Collection': score.dim_collection || '-',
                    'Process': score.dim_process || '-',
                    'Composite': score.composite || '-',
                    'Grade': score.grade || '-'
                };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Hospitals');
            XLSX.writeFile(wb, 'R7_Assessment_Export.xlsx');
        }

        async function exportHospitalExcel() {
            const result = await callAPI('getScores', { hospital_code: currentHospital.code });
            if (!result.success) return;

            const data = result.scores.map(s => ({
                '‡∏£‡∏≠‡∏ö': s.round,
                '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': s.date,
                'Raw Score': s.total_raw,
                'Revenue': s.dim_revenue,
                'Cost': s.dim_cost,
                'Discipline': s.dim_discipline,
                'Collection': s.dim_collection,
                'Process': s.dim_process,
                'Composite': s.composite,
                'Grade': s.grade
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Scores');
            XLSX.writeFile(wb, `R7_${currentHospital.code}_Export.xlsx`);
        }

        // ==================== INIT ====================
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
    </script>
</body>
</html>
