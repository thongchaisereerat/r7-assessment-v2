# Issue List - R7 Assessment System v3.1

| ID | Severity | Area | Symptom | Root Cause | File:Line | Proposed Fix | Verification Test |
|----|----------|------|---------|------------|-----------|--------------|-------------------|
| ISS-001 | **BLOCKER** | AuthN | Any user can gain admin access by typing `CU={role:'admin'}` in DevTools | Auth state stored in client-side JS variable `CU` with no server-side session validation | `build_v31.js:241` (`let CU=null`) | Implement server-side session tokens. After login, API returns a signed token (JWT or opaque). All subsequent API calls include this token. Server validates token on every request. | Open DevTools → set `CU={role:'admin'}` → click Import → should be blocked. After fix: Import button hidden AND `doImport()` rejects without valid token. |
| ISS-002 | **MAJOR** | Dashboard | Best Practice panel shows a hospital's peak score from any historical round as the benchmark, even when viewing a specific round | `openDetail()` and `loadMyDash()` filter `AS` by hospital level but NOT by current dashboard round filter | `build_v31.js:505` (`AS.filter(s=>{...hp.level===h.level...})`) and `build_v31.js:572` (same pattern) | Add round filter: `const rn=document.getElementById('fRnd').value; AS.filter(s=>{ const hp=AH.find(...); return hp && hp.level===h.level && (!rn \|\| s.round===rn) && ... })` | Select round "1/2568" in dashboard filter → click hospital → Best Practice should only show scores from round 1/2568. Assert `[data-testid="page-hospital-detail"]` best practice text contains "1/2568". |
| ISS-003 | **MINOR** | Assessment | Draft data is auto-saved but never restored when user returns to the form | `autoSave()` writes to key `r7_draft_<code>` but `loadDraft()` reads from key `r7_scores_<code>_<round>` (a different key pattern) | `build_v31.js:658` (autoSave writes `r7_draft_`) vs `build_v31.js:602` (loadDraft reads `r7_scores_`) | Either (a) change `loadDraft()` to read from `r7_draft_<code>` and merge, or (b) change `autoSave()` to write to `r7_scores_<code>_<round>` directly. Option (b) is simpler. Also add a "Restore draft?" prompt in `startAssess()`. | Start assessment → fill 5 items → navigate away without saving → return to assessment → items should be pre-filled from draft. |
| ISS-004 | **MAJOR** | Security | Login credentials (username + password) appear in URL query string, browser history, server access logs, and any intermediate proxy logs | `doLogin()` calls `gAPI('login', {username, password})` which uses GET with `URL.searchParams.append()` | `build_v31.js:521` (doLogin → gAPI) + `build_v31.js:282-283` (gAPI appends to URL) | Change login to use `pAPI()` (POST): `const r = await pAPI({action:'login', username:u, password:p})`. Requires server-side `doPost` to handle `action:'login'`. | Use browser DevTools Network tab → perform login → verify request method is POST and credentials are NOT in URL. |
| ISS-005 | **BLOCKER** | AuthZ | Any HTTP client can POST `saveScore` for any hospital_code. No server-side validation of who is submitting | API `saveScore` endpoint accepts `hospital_code` from POST body without verifying the caller's identity or hospital ownership | `build_v31.js:664` (payload includes `hospital_code` from client `CH.code`) → server-side `doPost()` in Google Apps Script | Server-side: validate session token, extract `hospital_code` from the authenticated session (not from the POST body). Reject if `user.role!=='hospital' \|\| user.hospital_code !== payload.hospital_code` (unless admin). | Using curl/Postman, POST `saveScore` with a different hospital_code than the logged-in user → should return `{success:false, error:'unauthorized'}`. |
| ISS-006 | **MAJOR** | AuthZ | `doImport()` function has no role check — any script in console can call it to bulk-import data | Function relies on UI-level hiding of the Import button (line 272) but the function itself is globally accessible with no guard | `build_v31.js:804` (`async function doImport()`) | Add role guard at top of `doImport()`: `if(!CU \|\| CU.role!=='admin'){alert('Admin only');return;}`. Also add server-side check in the API. | Log in as hospital user → call `doImport()` from console → should see "Admin only" alert and no data written. |
| ISS-007 | **MAJOR** | Data | Excel import sends raw row data to API with no schema validation. Arbitrary keys/values pass through. | `doImport()` iterates Excel rows and copies ALL columns to API payload: `for(let k in row) p[k]=row[k]` | `build_v31.js:808-809` | Validate each row against expected schema before sending. Check required fields (`hospital_code`, `round`, item scores). Reject rows with unexpected columns. Sanitize values. | Import an Excel with an extra column "malicious_field" → verify it is stripped from the API payload. Import a row missing `hospital_code` → verify it is rejected. |
| ISS-008 | **MAJOR** | Scoring | Non-M1/M2/A hospitals have item 6.4 hidden (not scoreable) but `calcDims()` still divides Cost by max_raw=25, making their max achievable Cost% = 80% instead of 100% | `renderItems()` hides 6.4 via `if(!show)return`, `collectForm()` sets hidden items to '0', but `calcDims()` always sums all 5 Cost items and divides by 25 | `build_v31.js:615-616` (hide), `build_v31.js:655` (collect '0'), `build_v31.js:359,363` (sum/divide by 25) | When `6.4` is not applicable, adjust Cost max_raw to 20 instead of 25. Pass hospital level to `calcDims()` and conditionally set `coMax = (level applies to 6.4) ? 25 : 20`. Update `scoring_rules.json` to document this. | Score all Cost items (6.1-6.5) at 5 for an F2 hospital → Cost% should be `20/20 = 100%`, not `20/25 = 80%`. Add test case to `scoring.test.js`. |
| ISS-009 | **MAJOR** | Security | No session timeout — once logged in, the session persists until manual logout or page refresh | `CU` is set once at login and never checked for staleness. No timer to auto-logout. | `build_v31.js:524-525` (CU set on login success) | Add a session timeout: store login timestamp, check on each `showPage()` call. If >30 min since login, call `doLogout()` and show timeout message. | Log in → wait 31 minutes (or mock Date) → attempt navigation → should auto-logout and show "Session expired". |
| ISS-010 | **MINOR** | Performance | Tailwind CSS loaded from unpinned CDN URL — a breaking change in Tailwind v4 could break the entire UI | `cdn.tailwindcss.com` has no version specifier; always loads latest | `build_v31.js:14` | Pin to specific version: `https://cdn.tailwindcss.com/3.4.17` (or latest stable 3.x). | Verify `<script src>` URL in generated `index.html` includes version number. Add smoke test assertion. |
| ISS-011 | **MINOR** | Data | Fixture documentation contains incorrect expected values (Process raw=18 instead of 17, pct=33 instead of 31 in low case) | Manual calculation errors in the `expected` JSON documentation fields; actual test assertions are correct | `data/fixtures/golden_case_low.json:53-55,59` | Update `expected.dimensions.process.raw` to 17, `pct` to 31. Update `expected.composite_calc` to use correct values. | Re-run `scoring.test.js` → all 34 tests still pass. Verify fixture `expected` values match test assertions. |
| ISS-012 | **MINOR** | UX | User can submit assessment form with zero items scored — no completeness validation | `saveAssess()` checks only `d.date` (line 663). No check on whether all applicable items have scores. | `build_v31.js:660-663` | Add validation: count filled items vs applicable items. If `filled < total`, show confirmation dialog: "คุณกรอกเพียง X/Y ข้อ ต้องการบันทึกหรือไม่?" | Leave all items blank → click Save → should see confirmation prompt. Cancel → stay on form. Confirm → save proceeds. |
| ISS-013 | **MINOR** | Audit | No record of WHO submitted or modified an assessment — no audit trail | `saveAssess()` payload at line 664 does not include `username` or `user_role` fields | `build_v31.js:664` (payload construction) | Add `payload.submitted_by = CU.username; payload.submitted_role = CU.role;` in `saveAssess()`. Server-side: log these fields alongside the score record with timestamp. | After saving, check Google Sheets data → verify `submitted_by` column contains the username. |
| ISS-014 | **MINOR** | Performance | API calls have no timeout — a slow/dead Google Apps Script endpoint will hang the UI indefinitely with a loading spinner | `gAPI()` and `pAPI()` use native `fetch()` without `AbortController` or timeout | `build_v31.js:281-289` | Wrap fetch calls with `AbortController` and a 15-second timeout. On timeout, return `{success:false, error:'Request timeout'}` and hide loading overlay. | Simulate network timeout (DevTools throttle "Offline") → verify loading spinner disappears after 15s with an error message. |
